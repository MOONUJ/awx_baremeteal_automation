#!/bin/bash
# ISO 인덱스 생성 스크립트
# {{ ansible_managed }}

BASE_PATH="{{ iso_base_path }}"
CUSTOM_PATH="{{ iso_custom_path }}"
BACKUP_PATH="{{ iso_backup_path }}"
WEB_ROOT="{{ repo_web_root }}"

# HTML 인덱스 생성 함수
create_html_index() {
    local dir="$1"
    local title="$2"
    local index_file="$dir/index.html"
    
    cat > "$index_file" << EOF
<!DOCTYPE html>
<html>
<head>
    <title>$title</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .iso-file { color: #0066cc; }
        .checksum { font-family: monospace; font-size: 0.9em; }
        .metadata { color: #666; }
    </style>
</head>
<body>
    <h1>$title</h1>
    <p>Last updated: $(date)</p>
    <table>
        <tr>
            <th>파일명</th>
            <th>크기</th>
            <th>수정일</th>
            <th>타입</th>
            <th>체크섬</th>
        </tr>
EOF

    # ISO 파일들을 테이블에 추가
    find "$dir" -name "*.iso" -type f | sort | while read -r file; do
        if [ -f "$file" ]; then
            filename=$(basename "$file")
            filesize=$(du -h "$file" | cut -f1)
            modtime=$(stat -c %y "$file" | cut -d. -f1)
            
            # MD5 체크섬 확인
            md5sum=""
            if [ -f "${file}.md5" ]; then
                md5sum=$(cut -d' ' -f1 "${file}.md5")
            fi
            
            echo "        <tr>" >> "$index_file"
            echo "            <td class=\"iso-file\"><a href=\"$filename\">$filename</a></td>" >> "$index_file"
            echo "            <td>$filesize</td>" >> "$index_file"
            echo "            <td>$modtime</td>" >> "$index_file"
            echo "            <td>ISO Image</td>" >> "$index_file"
            echo "            <td class=\"checksum\">$md5sum</td>" >> "$index_file"
            echo "        </tr>" >> "$index_file"
            
            # 관련 파일들 추가 (MD5, SHA256, JSON)
            for ext in md5 sha256 json; do
                if [ -f "${file}.${ext}" ]; then
                    extfile=$(basename "${file}.${ext}")
                    extsize=$(du -h "${file}.${ext}" | cut -f1)
                    extmodtime=$(stat -c %y "${file}.${ext}" | cut -d. -f1)
                    
                    echo "        <tr>" >> "$index_file"
                    echo "            <td class=\"metadata\"><a href=\"$extfile\">$extfile</a></td>" >> "$index_file"
                    echo "            <td>$extsize</td>" >> "$index_file"
                    echo "            <td>$extmodtime</td>" >> "$index_file"
                    echo "            <td>${ext^^} File</td>" >> "$index_file"
                    echo "            <td>-</td>" >> "$index_file"
                    echo "        </tr>" >> "$index_file"
                fi
            done
        fi
    done

    cat >> "$index_file" << EOF
    </table>
    
    <hr>
    <p><small>Generated by ISO Repository Server</small></p>
</body>
</html>
EOF
}

# 각 디렉토리에 대해 인덱스 생성
if [ -d "$BASE_PATH" ]; then
    create_html_index "$BASE_PATH" "Base ISO Files"
fi

if [ -d "$CUSTOM_PATH" ]; then
    create_html_index "$CUSTOM_PATH" "Custom ISO Files"
fi

if [ -d "$BACKUP_PATH" ]; then
    create_html_index "$BACKUP_PATH" "Backup ISO Files"
fi

# 메인 웹 루트 인덱스 생성
cat > "$WEB_ROOT/index.html" << EOF
<!DOCTYPE html>
<html>
<head>
    <title>ISO Repository Server</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .directory { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .directory h2 { margin-top: 0; color: #333; }
        .directory a { text-decoration: none; color: #0066cc; font-weight: bold; }
        .stats { background-color: #f9f9f9; padding: 10px; margin: 10px 0; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>ESXi ISO Repository Server</h1>
    <p>Welcome to the ESXi ISO Repository Server. Last updated: $(date)</p>
    
    <div class="directory">
        <h2>Base ISO Files</h2>
        <p>Original ESXi ISO images</p>
        <a href="/base/">Browse Base ISOs →</a>
        <div class="stats">
            Files: $(find "$BASE_PATH" -name "*.iso" 2>/dev/null | wc -l)
        </div>
    </div>
    
    <div class="directory">
        <h2>Custom ISO Files</h2>
        <p>Customized ESXi ISO images with kickstart configurations</p>
        <a href="/custom/">Browse Custom ISOs →</a>
        <div class="stats">
            Files: $(find "$CUSTOM_PATH" -name "*.iso" 2>/dev/null | wc -l)
        </div>
    </div>
    
    <div class="directory">
        <h2>Backup ISO Files</h2>
        <p>Archived and backup ISO images</p>
        <a href="/backup/">Browse Backup ISOs →</a>
        <div class="stats">
            Files: $(find "$BACKUP_PATH" -name "*.iso" 2>/dev/null | wc -l)
        </div>
    </div>
    
    <hr>
    <p><small>Generated by ISO Repository Server on {{ inventory_hostname }}</small></p>
</body>
</html>
EOF

echo "ISO 인덱스 업데이트 완료: $(date)"